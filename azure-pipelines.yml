# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
  branches:
    include:
      - master

pool:
  vmImage: "ubuntu-latest"

steps:
  - script: |
      docker ps -a
      docker --version
    displayName: "Check Docker installation "

  - task: DownloadSecureFile@1
    name: aws_creds
    displayName: "Download source script to export AWS creds"
    inputs:
      secureFile: "i-platform-dev-aws-creds.sh"

  - task: Bash@3
    inputs:
      targetType: "inline"
      script: |
        sudo chown root:root $(aws_creds.secureFilePath)
        sudo chmod a+r $(aws_creds.secureFilePath)
        . $(aws_creds.secureFilePath)
        aws s3 ls
        make create_release_images

  - task: Bash@3
    inputs:
      targetType: "inline"
      script: |
        . $(aws_creds.secureFilePath)
        docker run -i \
        --env AWS_DEFAULT_REGION=us-east-1 \
        --env AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}" \
        --env AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}" \
        devops-tools:latest terraform --version
